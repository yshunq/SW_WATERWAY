C51 COMPILER V9.00   24CXX                                                                 10/11/2024 17:50:12 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE 24CXX
OBJECT MODULE PLACED IN ..\hex\24cxx.obj
COMPILER INVOKED BY: C:\Keil _C51\C51\BIN\C51.EXE ..\user\24cxx.c LARGE OPTIMIZE(9,SPEED) BROWSE INCDIR(..\user;..\displ
                    -ay;..\common;..\cut;..\count) DEBUG OBJECTEXTEND PRINT(.\LIST\24cxx.lst) OBJECT(..\hex\24cxx.obj)

line level    source

   1          #include "24cxx.h"
   2          
   3          //--------------33177600L-----------//
   4          
   5          //产生IIC起始信号
   6          void IIC_Start(void)
   7          {
   8   1              //SDA_OUT();     //sda线输出
   9   1              IIC_SDA=1;                
  10   1              IIC_SCL=1;
  11   1              _nop_();_nop_();_nop_();_nop_();
  12   1              _nop_();_nop_();_nop_();_nop_();
  13   1              _nop_();_nop_();_nop_();_nop_();
  14   1              IIC_SDA=0;//START:when CLK is high,DATA change form high to low 
  15   1              _nop_();_nop_();_nop_();_nop_();
  16   1              _nop_();_nop_();_nop_();_nop_();
  17   1              _nop_();_nop_();_nop_();_nop_();
  18   1              //IIC_SCL=0;//钳住I2C总线，准备发送或接收数据 
  19   1      }
  20          
  21          //产生IIC停止信号
  22          void IIC_Stop(void)
  23          {
  24   1              //SDA_OUT();//sda线输出
  25   1              IIC_SCL=1;
  26   1              IIC_SDA=0;//STOP:when CLK is high DATA change form low to high
  27   1              _nop_();_nop_();_nop_();_nop_();
  28   1              _nop_();_nop_();_nop_();_nop_();
  29   1              _nop_();_nop_();_nop_();_nop_();
  30   1              IIC_SCL=1; 
  31   1              IIC_SDA=1;//发送I2C总线结束信号
  32   1              _nop_();_nop_();_nop_();_nop_();
  33   1              _nop_();_nop_();_nop_();_nop_();
  34   1              _nop_();_nop_();_nop_();_nop_();                                                        
  35   1      }       
  36          
  37          //IIC发送一个字节
  38          //返回从机有无应答
  39          //1，有应答
  40          //0，无应答                       
  41          void IIC_Send_Byte(u8 txd)
  42          {                        
  43   1              u8 t;   
  44   1              //SDA_OUT();        
  45   1              IIC_SCL=0;//拉低时钟开始数据传输
  46   1              for(t=0;t<8;t++){              
  47   2                      IIC_SDA=(txd&0x80)>>7;
  48   2                      txd<<=1;          
  49   2                      _nop_();_nop_();_nop_();
  50   2                      IIC_SCL=1;
  51   2                      _nop_();_nop_();_nop_();
  52   2                      IIC_SCL=0;      
  53   2                      _nop_();_nop_();_nop_();
  54   2        }      
C51 COMPILER V9.00   24CXX                                                                 10/11/2024 17:50:12 PAGE 2   

  55   1      } 
  56          
  57          //等待应答信号到来
  58          //返回值：1，接收应答失败
  59          //        0，接收应答成功
  60          u8 IIC_Wait_Ack(void)
  61          {
  62   1              u8 ucErrTime=0;
  63   1              //SDA_IN();      //SDA设置为输入  
  64   1              IIC_SDA=1;_nop_();_nop_();_nop_();_nop_();         
  65   1              IIC_SCL=1;_nop_();_nop_();_nop_();_nop_();
  66   1              while(IIC_SDA){
  67   2                      ucErrTime++;
  68   2                      if(ucErrTime>250){
  69   3                              IIC_Stop();
  70   3                              return 1;
  71   3                      }
  72   2              }
  73   1              IIC_SCL=0;//时钟输出0      
  74   1              return 0;  
  75   1      } 
  76          
  77          //读1个字节，ack=1时，发送ACK，ack=0，发送nACK   
  78          u8 IIC_Read_Byte(unsigned char ack)
  79          {
  80   1              unsigned char i,receive=0;
  81   1              //SDA_IN();//SDA设置为输入
  82   1              for(i=0;i<8;i++ ){
  83   2              IIC_SCL=0; 
  84   2              _nop_();_nop_();_nop_();_nop_();_nop_();_nop_();
  85   2                      IIC_SCL=1;
  86   2                      _nop_();_nop_();_nop_();_nop_();
  87   2              receive<<=1;
  88   2              if(IIC_SDA)receive++;   
  89   2                      _nop_();_nop_();_nop_();_nop_();_nop_(); 
  90   2          }                                    
  91   1          if (!ack)
  92   1              IIC_NAck();//发送nACK
  93   1          else
  94   1              IIC_Ack(); //发送ACK   
  95   1          return receive;
  96   1      }
  97          
  98          //产生ACK应答
  99          void IIC_Ack(void)
 100          {
 101   1              IIC_SCL=0;
 102   1              //SDA_OUT();
 103   1              IIC_SDA=0;
 104   1              _nop_();_nop_();_nop_();
 105   1              _nop_();_nop_();_nop_();
 106   1              _nop_();_nop_();_nop_();
 107   1              IIC_SCL=1;
 108   1              _nop_();_nop_();_nop_();
 109   1              _nop_();_nop_();_nop_();
 110   1              _nop_();_nop_();_nop_();
 111   1              IIC_SCL=0;
 112   1      }
 113          
 114          //不产生ACK应答             
 115          void IIC_NAck(void)
 116          {
C51 COMPILER V9.00   24CXX                                                                 10/11/2024 17:50:12 PAGE 3   

 117   1              IIC_SCL=0;
 118   1              //SDA_OUT();
 119   1              IIC_SDA=1;
 120   1              _nop_();_nop_();_nop_();
 121   1              _nop_();_nop_();_nop_();
 122   1              _nop_();_nop_();_nop_();
 123   1              IIC_SCL=1;
 124   1              _nop_();_nop_();_nop_();
 125   1              _nop_();_nop_();_nop_();
 126   1              _nop_();_nop_();_nop_();
 127   1              IIC_SCL=0;
 128   1      }       
 129          
 130          //在AT24CXX指定地址读出一个数据
 131          //ReadAddr:开始读数的地址  
 132          //返回值  :读到的数据
 133          u8 AT24CXX_ReadOneByte(u16 ReadAddr)
 134          {                                 
 135   1              u8 temp=0;                                                                                                                                                       
 136   1              IIC_Start();  
 137   1              if(EE_TYPE>AT24C16){
 138   2      //              IIC_Send_Byte(0xA0);       //发送写命令
 139   2      //              IIC_Wait_Ack();
 140   2      //              IIC_Send_Byte(ReadAddr>>8);//发送高地址
 141   2      //              IIC_Wait_Ack();          
 142   2              }else IIC_Send_Byte(0XA0+((ReadAddr/256)<<1));   //发送器件地址0XA0,写数据       
 143   1      
 144   1              IIC_Wait_Ack(); 
 145   1              IIC_Send_Byte(ReadAddr%256);   //发送低地址
 146   1              IIC_Wait_Ack();     
 147   1              IIC_Start();               
 148   1              IIC_Send_Byte(0XA1);           //进入接收模式                      
 149   1              IIC_Wait_Ack();  
 150   1              temp=IIC_Read_Byte(0);             
 151   1              IIC_Stop();//产生一个停止条件       
 152   1              return temp;
 153   1      }
 154          
 155          //在AT24CXX指定地址写入一个数据
 156          //WriteAddr  :写入数据的目的地址    
 157          //DataToWrite:要写入的数据
 158          void AT24CXX_WriteOneByte(u16 WriteAddr,u8 DataToWrite)
 159          {                                                                                                                                                                                
 160   1          IIC_Start();  
 161   1              if(EE_TYPE>AT24C16){
 162   2      //              IIC_Send_Byte(0xA0);        //发送写命令
 163   2      //              IIC_Wait_Ack();
 164   2      //              IIC_Send_Byte(WriteAddr>>8);//发送高地址
 165   2              }else{
 166   2                      IIC_Send_Byte(0XA0+((WriteAddr/256)<<1));   //发送器件地址0XA0,写数据 
 167   2              }        
 168   1              IIC_Wait_Ack();    
 169   1          IIC_Send_Byte(WriteAddr%256);   //发送低地址
 170   1              IIC_Wait_Ack();                                                                                                            
 171   1              IIC_Send_Byte(DataToWrite);     //发送字节                                                         
 172   1              IIC_Wait_Ack();                            
 173   1          IIC_Stop();//产生一个停止条件 
 174   1              delay_ms(10);    
 175   1      }
 176          
 177          
 178          
C51 COMPILER V9.00   24CXX                                                                 10/11/2024 17:50:12 PAGE 4   

 179          
 180          
 181          
 182          
 183          
 184          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    344    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----       1
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
